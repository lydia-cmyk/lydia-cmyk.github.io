<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POMODORO+ Â· ì§‘ì¤‘ íƒ€ì´ë¨¸ & ê³µë¶€ ê¸°ë¡</title>
  <meta name="description" content="ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸ì™€ í•™ìŠµ ë…¸í•˜ìš°. ì´ë¯¸ì§€/ë§ˆí¬ë‹¤ìš´ ì§€ì› ë¸”ë¡œê·¸ í¬í•¨." />
  <style>
    :root{
      --bg:#0a0c12; --panel:#10131b; --panel-2:#151a24;
      --text:#edf2f7; --muted:#9aa0a6; --acc:#ff4d4f; --ring:#2a2f3a;
      --glow1: 0 0 32px rgba(255,77,79,.22), 0 0 8px rgba(255,77,79,.35);
      --glow2: 0 0 36px rgba(138,180,248,.18), inset 0 0 0 1px rgba(255,255,255,.02);
      --prose:#cfd6e4;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Roboto,Noto Sans KR,Helvetica,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;font-variant-numeric:tabular-nums}
    .container{max-width:1080px;margin:0 auto;padding:28px}
    header.site{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{display:grid;place-items:center;width:42px;height:42px;border-radius:12px;background: radial-gradient(120% 120% at 30% 20%, #ff725e, #c92028 70%);box-shadow:var(--glow1)}
    .logo span{filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
    .wordmark{font-weight:900;letter-spacing:.8px;font-size:20px;background:linear-gradient(90deg,#fff,#cbd5e1);-webkit-background-clip:text;background-clip:text;color:transparent}
    nav a{margin-left:16px;color:var(--text);text-decoration:none;font-weight:700;opacity:.9}
    nav a:hover{text-decoration:underline;text-underline-offset:3px}
    main{margin-top:22px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:20px;padding:18px;box-shadow:var(--glow2)}
    .card h3{margin:0 0 12px;font-size:13px;color:#c7cbd1;font-weight:800;letter-spacing:.3px}
    .timer-card{flex:1 1 360px;display:grid;justify-items:center;text-align:center}
    .ring{position:relative;width:340px;height:340px;filter:drop-shadow(0 10px 24px rgba(255,77,79,.18))}
    .ring svg{transform:rotate(-90deg)} .time{position:absolute;inset:0;display:grid;place-items:center}
    .mmss{font-size:64px;font-weight:900;letter-spacing:1px;text-shadow:0 2px 10px rgba(0,0,0,.35)}
    .mode{margin-top:8px;font-size:13px;color:#cbd5e1;letter-spacing:.4px}
    .controls{display:flex;gap:8px;justify-content:center;margin-top:10px}
    button{background:#1a1f2b;color:var(--text);border:1px solid var(--ring);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    .primary{background:var(--acc);border-color:#b3262e;color:#fff}
    .ghost{background:transparent}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .tab{padding:9px 14px;border-radius:999px;background:var(--panel-2);border:1px solid var(--ring);color:var(--text);cursor:pointer}
    .tab[aria-pressed="true"],.tab[aria-selected="true"]{background:#1e2431;outline:2px solid #2b3240;color:#fff}
    .tasks{flex:1 1 320px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input[type="text"],input[type="number"],input[type="range"]{width:100%;background:#0e1220;color:#fff;border:1px solid #2a3140;border-radius:10px;padding:10px}
    label{font-size:12px;color:#b2bac7;display:block;margin-bottom:6px}
    .blog-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px}
    .post-card{display:block;overflow:hidden;border-radius:16px;border:1px solid var(--ring);background:linear-gradient(180deg,#11151e,#0e121b)}
    .post-thumb{aspect-ratio:16/9;background-size:cover;background-position:center;background-image:linear-gradient(135deg,#1e2634,#131a27)}
    .post-meta{padding:12px 12px 14px}.post-title{font-weight:900;color:var(--text);font-size:15px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .post-date{font-size:12px;color:#9aa0a6}
    #postView{margin-top:16px}.article h1{font-size:28px;margin:0 0 10px;font-weight:900}
    .article .meta{color:#9aa0a6;font-size:13px;margin-bottom:16px}.article .content{color:#cfd6e4;line-height:1.75}
    .article .content h2{font-size:20px;margin:20px 0 6px}.article .content h3{font-size:17px;margin:16px 0 6px}
    .article .content p{margin:10px 0}.article .content ul{margin:8px 0 12px 20px}.article .content li{margin:4px 0}
    .article .content img{max-width:100%;height:auto;display:block;margin:12px auto;border-radius:12px}
    .footer{margin-top:28px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;color:#9aa0a6}
    .pill{padding:6px 10px;background:var(--panel-2);border:1px solid var(--ring);border-radius:999px;font-size:12px}.link{color:#8ab4f8;text-underline-offset:2px}
  </style>
</head>
<body>
<div class="container">
  <header class="site">
    <div class="brand"><div class="logo"><span>ğŸ…</span></div><div class="wordmark">POMODORO+</div></div>
    <nav><a href="#">í™ˆ</a><a href="#blog">ë¸”ë¡œê·¸</a><a href="#about">ì†Œê°œ</a><a href="#contact">ì—°ë½ì²˜</a></nav>
  </header>
  <main>
    <section id="homeFlag" class="row">
      <section class="card timer-card" aria-label="íƒ€ì´ë¨¸">
        <div id="modeBtns" class="tabs" role="tablist" aria-label="ëª¨ë“œ">
          <button class="tab" data-mode="focus" aria-selected="true">ì§‘ì¤‘</button>
          <button class="tab" data-mode="short">ì§§ì€ íœ´ì‹</button>
          <button class="tab" data-mode="long">ê¸´ íœ´ì‹</button>
        </div>
        <div class="ring" aria-live="polite">
          <svg width="100%" height="100%" viewBox="0 0 300 300" aria-hidden="true">
            <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ff8a80"/><stop offset="100%" stop-color="#ff4d4f"/>
            </linearGradient></defs>
            <circle cx="150" cy="150" r="140" fill="none" stroke="var(--ring)" stroke-width="16" />
            <circle id="ring" cx="150" cy="150" r="140" fill="none" stroke="url(#grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0" stroke-dashoffset="0"/>
          </svg>
          <div class="time"><div class="mmss" id="time">25:00</div><div class="mode" id="mode">ì§‘ì¤‘</div></div>
        </div>
        <div class="controls">
          <button id="startBtn" class="primary">ì‹œì‘</button>
          <button id="pauseBtn" class="ghost" hidden>ì¼ì‹œì •ì§€</button>
          <button id="resetBtn" class="ghost">ë¦¬ì…‹</button>
          <button id="nextBtn" class="ghost">ë‹¤ìŒ â–¶ï¸</button>
        </div>
        <div class="muted small" style="margin-top:8px">ì˜¤ëŠ˜ ì™„ë£Œí•œ ì§‘ì¤‘: <span id="completed">0</span>íšŒ</div>
      </section>
      <section class="card tasks" aria-label="ì‘ì—…">
        <h3>ì‘ì—…</h3>
        <div class="grid-2" style="margin-bottom:8px">
          <div><label for="taskTitle">ì‘ì—…ëª…</label><input id="taskTitle" type="text" placeholder="ì˜ˆ: ìˆ˜í•™ nì œ 4ë‹¨ì› ë³µìŠµ" /></div>
          <div><label for="taskEst">ì˜ˆìƒ ë½€ëª¨ ìˆ˜</label><input id="taskEst" type="number" min="1" value="1" /></div>
        </div>
        <button id="addTaskBtn">ì‘ì—… ì¶”ê°€</button>
        <div id="taskList" style="margin-top:12px; display:grid; gap:8px"></div>
      </section>
    </section>

    <section class="row" style="margin-top:16px">
      <section class="card" style="flex:1 1 380px" aria-label="ì„¤ì •">
        <h3>ì„¤ì •</h3>
        <div class="grid-2">
          <div><label for="focusMin">ì§‘ì¤‘ (ë¶„)</label><input id="focusMin" type="number" min="1" /></div>
          <div><label for="shortMin">ì§§ì€ íœ´ì‹ (ë¶„)</label><input id="shortMin" type="number" min="1" /></div>
          <div><label for="longMin">ê¸´ íœ´ì‹ (ë¶„)</label><input id="longMin" type="number" min="1" /></div>
          <div><label for="longEvery">ê¸´ íœ´ì‹ ì£¼ê¸° (ì§‘ì¤‘ ëª‡ íšŒë§ˆë‹¤)</label><input id="longEvery" type="number" min="2" /></div>
          <div><label><input id="autoBreak" type="checkbox" /> íœ´ì‹ ìë™ ì‹œì‘</label></div>
          <div><label><input id="autoFocus" type="checkbox" /> ì§‘ì¤‘ ìë™ ì‹œì‘</label></div>
          <div><label><input id="sound" type="checkbox" /> ì•Œë¦¼ìŒ</label></div>
          <div><label for="volume">ë³¼ë¥¨</label><input id="volume" type="range" min="0" max="1" step="0.01" /></div>
          <div><label><input id="notify" type="checkbox" /> ë°ìŠ¤í¬í†± ì•Œë¦¼</label></div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px">
          <button id="resetToday" type="button" class="ghost">ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
          <button id="resetAll" type="button" class="ghost" style="border-color:#b3262e;color:#ffb3b3">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
      </section>

      <section class="card" style="flex:1 1 380px" aria-label="í†µê³„/ê°€ì´ë“œ">
        <h3>ì˜¤ëŠ˜ì˜ ê¸°ë¡</h3>
        <div class="pill" style="display:inline-flex; gap:8px; align-items:center">â±ï¸ <span id="statsToday">0íšŒ Â· 0ë¶„</span> Â· ğŸ”¥ <span id="streak">0ì¼ ì—°ì†</span></div>
        <details style="margin-top:14px">
          <summary>ë½€ëª¨ë„ë¡œ íŒ (ê°„ë‹¨ ìš”ì•½)</summary>
          <ul>
            <li>25ë¶„ ì§‘ì¤‘ + 5ë¶„ íœ´ì‹(4íšŒ í›„ 15ë¶„ íœ´ì‹)ì„ ê¸°ë³¸ìœ¼ë¡œ ì‹œì‘í•˜ê³ , ë³¸ì¸ì—ê²Œ ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.</li>
            <li>ê° ì„¸ì…˜ì—ëŠ” <b>í•˜ë‚˜ì˜ êµ¬ì²´ì ì¸ ì‘ì—…</b>ë§Œ ì„ íƒí•˜ì„¸ìš”. ì‹œì‘ ì „ì— ëª©í‘œë¥¼ í•œ ì¤„ë¡œ ê¸°ë¡í•´ ë³´ì„¸ìš”.</li>
            <li>íœ´ì‹ ì‹œê°„ì—ëŠ” ë‡Œë¥¼ ì‰¬ê²Œ í•˜ì„¸ìš”. íœ´ëŒ€ì „í™”ëŠ” ë©€ë¦¬ ë‘ê³ , ë¬¼ì„ ë§ˆì‹œê±°ë‚˜ ê°€ë³ê²Œ ìŠ¤íŠ¸ë ˆì¹­í•´ ë³´ì„¸ìš”.</li>
            <li>í•˜ë£¨ê°€ ëë‚˜ë©´ ì˜¤ëŠ˜ì˜ ì„¸ì…˜/ì‹œê°„ì„ í™•ì¸í•˜ê³ , ë‚´ì¼ì˜ ì‘ì—…ì„ ë¯¸ë¦¬ ë“±ë¡í•´ ë‘ì„¸ìš”.</li>
          </ul>
          <p class="notice">â€» ê¸°ë¡ì€ ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤(localStorage). ë‹¤ë¥¸ ê¸°ê¸°ì™€ëŠ” ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </details>
      </section>
    </section>

    <section class="card" aria-label="ìµœê·¼ ê²Œì‹œê¸€" id="blog" style="margin-top:16px">
      <h3>ìµœê·¼ ê¸€</h3>
      <div class="blog-grid" id="blogGrid" aria-live="polite"></div>
      <div style="margin-top:10px"><a href="#" class="link">ëª¨ë“  ê¸€ ë³´ê¸° â†’</a></div>
    </section>

    <section id="postView" class="card article" hidden>
      <div class="meta"><a href="#" id="backHome" class="link">â† ëª©ë¡ìœ¼ë¡œ</a></div>
      <article class="content" id="article"></article>
    </section>
  </main>

  <div class="footer">
    <div class="small">Â© POMODORO+ Â· í•™ìŠµ ìƒì‚°ì„± ë¸”ë¡œê·¸ & íƒ€ì´ë¨¸</div>
    <div class="small">ì´ í”„ë¦¬ë·°ëŠ” ë‹¨ì¼ íŒŒì¼ì´ì•¼. ì‹¤ì œ ì‚¬ì´íŠ¸ íŒ¨í‚¤ì§€ëŠ” ë³„ë„ ì œê³µ.</div>
  </div>
</div>

<script>
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const store = { get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(_){ return d } }, set(k, v){ localStorage.setItem(k, JSON.stringify(v)) } };
  const fmt2 = n=>String(n).padStart(2,'0');
  const todayKey = ()=> new Date().toISOString().slice(0,10);

  // Audio & Notification
  let audioCtx=null; let audioUnlocked=false;
  function ensureAudio(){ try{ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended'){ audioCtx.resume(); } audioUnlocked=true; }catch(e){ console.warn('Audio init failed', e); } }
  function playChime(kind='done'){
    if(!state.sound || !audioCtx || !audioUnlocked) return;
    const vol = Math.max(0, Math.min(1, state.volume||0.4));
    function tone(freq, dur, start){
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=freq; osc.connect(g); g.connect(audioCtx.destination);
      const t0 = audioCtx.currentTime + (start||0);
      g.gain.setValueAtTime(0, t0); g.gain.linearRampToValueAtTime(vol*0.35, t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
      osc.start(t0); osc.stop(t0+dur+0.05);
    }
    if(kind==='focusEnd'){ tone(880,0.12,0.00); tone(1175,0.12,0.15); }
    else { tone(523.25,0.10,0.00); tone(659.25,0.10,0.12); tone(783.99,0.12,0.24); }
  }
  function notifyUser(title, body){ if(!state.notify) return; try{ if('Notification' in window && Notification.permission==='granted'){ new Notification(title,{ body }); } }catch(e){} }

  // Timer state
  const defaultState = { mode:'focus', durations:{focus:25, short:5, long:15}, longInterval:4, completedFocus:0, remainingMs:25*60*1000, isRunning:false, autoStartBreaks:true, autoStartFocus:false, sound:true, volume:0.4, notify:true, selectedTaskId:null };
  let state = Object.assign({}, defaultState, store.get('pomo:state', {}));
  let tasks = store.get('pomo:tasks', []);
  let stats = store.get('pomo:stats', {});
  let endAt=null, rafId=null;

  function durationMs(mode){ return (state.durations[mode]||25)*60*1000 }
  function persist(){ store.set('pomo:state', state) }
  function addStat(key, delta){
    const k=todayKey(); const base=stats[k]||{sessions:0, focusMs:0};
    if(key==='sessions') base.sessions=(base.sessions|0)+delta; else base[key]=(base[key]||0)+delta;
    stats[k]=base; store.set('pomo:stats', stats); renderStats();
  }
  const getTodaySessions = ()=> (stats[todayKey()]?.sessions|0);
  function resetTodayStats(){ const k=todayKey(); stats[k]={sessions:0, focusMs:0}; store.set('pomo:stats', stats); }
  function resetAllData(){ localStorage.removeItem('pomo:state'); localStorage.removeItem('pomo:tasks'); localStorage.removeItem('pomo:stats'); state=Object.assign({}, defaultState); tasks=[]; stats={}; persist(); }

  function setMode(mode){ state.mode=mode; state.remainingMs=durationMs(mode); state.isRunning=false; endAt=null; clearInterval(rafId); persist(); updateUI(); }
  function start(){ if(state.isRunning) return; state.isRunning=true; endAt=Date.now()+state.remainingMs; tick(); rafId=setInterval(tick,200); persist(); }
  function pause(){ if(!state.isRunning) return; state.isRunning=false; state.remainingMs=Math.max(0,endAt-Date.now()); clearInterval(rafId); rafId=null; persist(); updateUI(); }
  function reset(){ state.isRunning=false; state.remainingMs=durationMs(state.mode); clearInterval(rafId); rafId=null; endAt=null; persist(); updateUI(); }
  function completeSession(){
    if(state.mode==='focus'){
      playChime('focusEnd'); notifyUser('ì§‘ì¤‘ ì¢…ë£Œ','íœ´ì‹ ì‹œê°„ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
      state.completedFocus++; addStat('sessions',1); addStat('focusMs', durationMs('focus'));
      if(state.selectedTaskId){ const t=tasks.find(t=>t.id===state.selectedTaskId); if(t){ t.done=Math.min((t.done||0)+1, t.est||99); saveTasks(); renderTasks(); } }
      const nextIsLong=(state.completedFocus%state.longInterval)===0; setMode(nextIsLong?'long':'short'); if(state.autoStartBreaks) start();
    } else { playChime('breakEnd'); notifyUser('íœ´ì‹ ì¢…ë£Œ','ë‹¤ìŒ ì§‘ì¤‘ì„ ì‹œì‘í•©ë‹ˆë‹¤.'); setMode('focus'); if(state.autoStartFocus) start(); }
    persist();
  }
  function next(){ completeSession(); }
  function tick(){ const left=endAt-Date.now(); if(left<=0){ state.remainingMs=0; updateUI(); clearInterval(rafId); rafId=null; completeSession(); return; } state.remainingMs=left; updateUI(); }

  function saveTasks(){ store.set('pomo:tasks', tasks) }
  function addTask(title, est){ const t={id:crypto.randomUUID(), title:title.trim(), est:Math.max(1, est|0), done:0}; if(!t.title) return; tasks.unshift(t); saveTasks(); renderTasks(); if(!state.selectedTaskId){ state.selectedTaskId=t.id; persist(); } }
  function delTask(id){ tasks=tasks.filter(t=>t.id!==id); saveTasks(); if(state.selectedTaskId===id){ state.selectedTaskId=tasks[0]?.id||null; persist(); } renderTasks(); }
  function selTask(id){ state.selectedTaskId=id; persist(); renderTasks(); }

  function mmss(ms){ const t=Math.ceil(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${fmt2(m)}:${fmt2(s)}` }

  function updateUI(){
    const total=durationMs(state.mode); const left=state.remainingMs; const pct=1-Math.max(0,Math.min(1,left/total));
    const r=140, C=2*Math.PI*r, off=C*pct; const ring=$('#ring'); if(ring){ ring.setAttribute('stroke-dasharray', C); ring.setAttribute('stroke-dashoffset', off); }
    const timeEl=$('#time'); if(timeEl) timeEl.textContent=mmss(left);
    const modeEl=$('#mode'); if(modeEl) modeEl.textContent= state.mode==='focus'?'ì§‘ì¤‘':(state.mode==='short'?'ì§§ì€ íœ´ì‹':'ê¸´ íœ´ì‹');
    document.title = `${mmss(left)} Â· ${(modeEl?modeEl.textContent:'ëª¨ë“œ')} â€” POMODORO+`;
    $$('#modeBtns button').forEach(b=> b.setAttribute('aria-pressed', b.dataset.mode===state.mode));
    const sb=$('#startBtn'), pb=$('#pauseBtn'); if(sb&&pb){ sb.hidden=state.isRunning; pb.hidden=!state.isRunning; }
    const fm=$('#focusMin'), sm=$('#shortMin'), lm=$('#longMin'), le=$('#longEvery'); if(fm) fm.value=state.durations.focus; if(sm) sm.value=state.durations.short; if(lm) lm.value=state.durations.long; if(le) le.value=state.longInterval;
    const ab=$('#autoBreak'), af=$('#autoFocus'), snd=$('#sound'), vol=$('#volume'), nt=$('#notify'); if(ab) ab.checked=state.autoStartBreaks; if(af) af.checked=state.autoStartFocus; if(snd) snd.checked=state.sound; if(vol) vol.value=state.volume; if(nt) nt.checked=state.notify;
    const comp=$('#completed'); if(comp) comp.textContent=getTodaySessions();
  }

  function renderTasks(){
    const wrap=$('#taskList'); if(!wrap) return; wrap.innerHTML='';
    if(tasks.length===0){ wrap.innerHTML='<div class="notice">ì•„ì§ ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì‘ì—…ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>'; return }
    tasks.forEach(t=>{
      const item=document.createElement('div'); item.className='task-item'; item.setAttribute('aria-current', state.selectedTaskId===t.id);
      item.innerHTML=`
    <input type="radio" name="sel" ${state.selectedTaskId===t.id?'checked':''} aria-label="í˜„ì¬ ì‘ì—… ì„ íƒ"/>
    <div class="task-title">${escapeHtml(t.title)} <span class="muted small">(${t.done||0}/${t.est})</span></div>
    <div class="task-actions">
      <button class="ok" title="ì™„ë£Œ 1 ì¦ê°€">+1</button>
      <button class="ghost" title="ìˆ˜ì •">í¸ì§‘</button>
      <button class="danger" title="ì‚­ì œ">ì‚­ì œ</button>
    </div>`;
      const [radio,,actions]=item.children;
      radio.addEventListener('change',()=>selTask(t.id));
      actions.children[0].addEventListener('click',()=>{ t.done=(t.done||0)+1; saveTasks(); renderTasks(); });
      actions.children[1].addEventListener('click',()=>{ const title=prompt('ì‘ì—…ëª…', t.title); if(title===null) return; const est=parseInt(prompt('ì˜ˆìƒ ë½€ëª¨ ìˆ˜', t.est),10); if(!title.trim()) return; t.title=title.trim(); t.est=isNaN(est)?t.est:Math.max(1,est); saveTasks(); renderTasks(); });
      actions.children[2].addEventListener('click',()=>{ if(confirm('ì‚­ì œí• ê¹Œ?')) delTask(t.id) });
      item.addEventListener('click', e=>{ if(e.target.tagName!=='BUTTON' && e.target.tagName!=='INPUT') selTask(t.id) });
      wrap.appendChild(item);
    });
  }

  function renderStats(){
    const k=todayKey(); const s=stats[k]||{sessions:0, focusMs:0};
    const st=$('#statsToday'); if(st) st.textContent=`${s.sessions|0}íšŒ Â· ${((s.focusMs||0)/60000)|0}ë¶„`;
    let streak=0; const dates=Object.keys(stats).sort().reverse(); let cur=new Date();
    for(const d of dates){ const y=cur.toISOString().slice(0,10); if(d===y && (stats[d]?.sessions||0)>0){ streak++; cur.setDate(cur.getDate()-1); } else break; }
    const se=$('#streak'); if(se) se.textContent=`${streak}ì¼ ì—°ì†`;
  }

  // Blog loader + Router (with images/links + new tab cards)
  let POSTS=[];
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])) }
  function md2html(md){
    let h = md.replace(/^###\s+(.+)$/gm,'<h3>$1</h3>')
              .replace(/^##\s+(.+)$/gm,'<h2>$1</h2>')
              .replace(/^#\s+(.+)$/gm,'<h1>$1</h1>');
    h = h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>');
    h = h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" loading="lazy">');
    h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
    h = h.replace(/(?:^|\n)-\s+(.+)(?=\n|$)/g,'\n<li>$1</li>');
    h = h.replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>');
    h = h.split(/\n{2,}/).map(x=>/^<h\d|<ul>|<li>|<img|<a/.test(x)?x:`<p>${x.trim()}</p>`).join('\n');
    return h;
  }
  async function loadPosts(){
    const grid=$('#blogGrid'); if(!grid) return;
    try{ const res=await fetch('/posts.json',{cache:'no-store'}); if(res.ok) POSTS=await res.json(); }catch(_){ POSTS=[] }
    if(!Array.isArray(POSTS) || POSTS.length===0){
      POSTS=[{slug:'hello',title:'ìƒ˜í”Œ ê¸€',date:'2025-08-01',md:'# ìƒ˜í”Œ\n\n![ìƒ˜í”Œ ì´ë¯¸ì§€](assets/desk-setup.jpg)'}];
    }
    grid.innerHTML='';
    POSTS.slice(0,12).forEach(p=>{
      const card=document.createElement('a');
      card.href=`#p/${p.slug}`;
      card.target='_blank'; card.rel='noopener'; // ìƒˆ íƒ­
      card.className='post-card'; card.dataset.slug=p.slug;
      const styleThumb = p.thumb ? ` style="background-image:url('${p.thumb}');"` : '';
      card.innerHTML=`<div class="post-thumb"${styleThumb}></div>
        <div class="post-meta">
          <div class="post-title">${escapeHtml(p.title||'ì œëª© ì—†ìŒ')}</div>
          <div class="post-date">${p.date?escapeHtml(p.date):''}</div>
        </div>`;
      grid.appendChild(card);
    });
  }
  function showHome(){ $('#homeFlag').hidden=false; $('#blog').hidden=false; $('#postView').hidden=true; }
  function showPost(slug){
    const p = POSTS.find(x=>x.slug===slug); if(!p){ showHome(); return; }
    const wrap=$('#article');
    const title=`<h1>${escapeHtml(p.title)}</h1><div class="meta">${escapeHtml(p.date||'')}</div>`;
    let body=''; if(p.html) body=p.html; else if(p.md) body=md2html(p.md); else body='<p>ë³¸ë¬¸ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´.</p>';
    wrap.innerHTML= title + `<div class="content">${body}</div>`;
    $('#homeFlag').hidden=true; $('#blog').hidden=true; $('#postView').hidden=false;
    document.title = `${p.title} â€” POMODORO+`;
  }
  function router(){ const m=location.hash.match(/^#p\/(?<slug>[a-z0-9\-]+)$/i); if(m&&m.groups?.slug){ showPost(m.groups.slug) } else { showHome() } }

  function bind(){
    $$('#modeBtns button').forEach(b=> b.addEventListener('click', ()=> setMode(b.dataset.mode)));
    const on=(sel,evt,fn)=>{ const el=$(sel); if(el) el.addEventListener(evt,fn) };
    on('#startBtn','click', ()=>{ ensureAudio(); start(); }); on('#pauseBtn','click', ()=>{ ensureAudio(); pause(); }); on('#resetBtn','click', ()=>{ ensureAudio(); reset(); }); on('#nextBtn','click', next);
    on('#addTaskBtn','click', ()=>{ const title=$('#taskTitle')?.value||''; const est=parseInt($('#taskEst')?.value||'1',10)||1; addTask(title, est); if($('#taskTitle')) $('#taskTitle').value=''; if($('#taskEst')) $('#taskEst').value=1; $('#taskTitle')?.focus(); });
    on('#focusMin','change', e=>{ state.durations.focus=Math.max(1, e.target.value|0); if(state.mode==='focus') state.remainingMs=durationMs('focus'); persist(); updateUI(); });
    on('#shortMin','change', e=>{ state.durations.short=Math.max(1, e.target.value|0); if(state.mode==='short') state.remainingMs=durationMs('short'); persist(); updateUI(); });
    on('#longMin','change', e=>{ state.durations.long=Math.max(1, e.target.value|0); if(state.mode==='long') state.remainingMs=durationMs('long'); persist(); updateUI(); });
    on('#longEvery','change', e=>{ state.longInterval=Math.max(2, e.target.value|0); persist(); });
    on('#autoBreak','change', e=>{ state.autoStartBreaks=e.target.checked; persist(); });
    on('#autoFocus','change', e=>{ state.autoStartFocus=e.target.checked; persist(); });
    on('#sound','change', e=>{ state.sound=e.target.checked; persist(); });
    on('#notify','change', e=>{ state.notify=e.target.checked; if(e.target.checked && Notification && Notification.permission!=='granted') Notification.requestPermission(); persist(); });
    on('#volume','input', e=>{ state.volume=Number(e.target.value); persist(); });
    on('#backHome','click', (e)=>{ e.preventDefault(); location.hash=''; });
    on('#resetToday','click', ()=>{ if(confirm('ì˜¤ëŠ˜ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')){ resetTodayStats(); renderStats(); updateUI(); }});
    on('#resetAll','click', ()=>{ if(confirm('ëª¨ë“  ë°ì´í„°(ì‘ì—…/ì„¤ì •/ê¸°ë¡)ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‚­ì œë©ë‹ˆë‹¤.')){ resetAllData(); renderTasks(); renderStats(); updateUI(); }});
    window.addEventListener('hashchange', router);
    window.addEventListener('pointerdown', ()=>ensureAudio(), { once:true });
  }
  async function init(){ bind(); if(state.remainingMs>durationMs(state.mode)) state.remainingMs=durationMs(state.mode); updateUI(); renderTasks(); renderStats(); await loadPosts(); router(); }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
