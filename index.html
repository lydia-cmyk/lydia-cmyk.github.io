<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POMODORO+ · 집중 타이머 & 공부 기록</title>
  <meta name="description" content="뽀모도로 타이머와 학습 노하우. 이미지/마크다운 지원 블로그 포함." />
  <style>
    :root{
      --bg:#0a0c12; --panel:#10131b; --panel-2:#151a24;
      --text:#edf2f7; --muted:#9aa0a6; --acc:#ff4d4f; --ring:#2a2f3a;
      --glow1: 0 0 32px rgba(255,77,79,.22), 0 0 8px rgba(255,77,79,.35);
      --glow2: 0 0 36px rgba(138,180,248,.18), inset 0 0 0 1px rgba(255,255,255,.02);
      --prose:#cfd6e4;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Roboto,Noto Sans KR,Helvetica,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;font-variant-numeric:tabular-nums}
    .container{max-width:1080px;margin:0 auto;padding:28px}
    header.site{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{display:grid;place-items:center;width:42px;height:42px;border-radius:12px;background: radial-gradient(120% 120% at 30% 20%, #ff725e, #c92028 70%);box-shadow:var(--glow1)}
    .logo span{filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
    .wordmark{font-weight:900;letter-spacing:.8px;font-size:20px;background:linear-gradient(90deg,#fff,#cbd5e1);-webkit-background-clip:text;background-clip:text;color:transparent}
    nav a{margin-left:16px;color:var(--text);text-decoration:none;font-weight:700;opacity:.9}
    nav a:hover{text-decoration:underline;text-underline-offset:3px}
    main{margin-top:22px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:20px;padding:18px;box-shadow:var(--glow2)}
    .card h3{margin:0 0 12px;font-size:13px;color:#c7cbd1;font-weight:800;letter-spacing:.3px}
    .timer-card{flex:1 1 360px;display:grid;justify-items:center;text-align:center}
    .ring{position:relative;width:340px;height:340px;filter:drop-shadow(0 10px 24px rgba(255,77,79,.18))}
    .ring svg{transform:rotate(-90deg)} .time{position:absolute;inset:0;display:grid;place-items:center}
    .mmss{font-size:64px;font-weight:900;letter-spacing:1px;text-shadow:0 2px 10px rgba(0,0,0,.35)}
    .mode{margin-top:8px;font-size:13px;color:#cbd5e1;letter-spacing:.4px}
    .controls{display:flex;gap:8px;justify-content:center;margin-top:10px}
    button{background:#1a1f2b;color:var(--text);border:1px solid var(--ring);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    .primary{background:var(--acc);border-color:#b3262e;color:#fff}
    .ghost{background:transparent}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .tab{padding:9px 14px;border-radius:999px;background:var(--panel-2);border:1px solid var(--ring);color:var(--text);cursor:pointer}
    .tab[aria-pressed="true"],.tab[aria-selected="true"]{background:#1e2431;outline:2px solid #2b3240;color:#fff}
    .tasks{flex:1 1 320px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input[type="text"],input[type="number"],input[type="range"]{width:100%;background:#0e1220;color:#fff;border:1px solid #2a3140;border-radius:10px;padding:10px}
    label{font-size:12px;color:#b2bac7;display:block;margin-bottom:6px}
    .blog-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px}
    .post-card{display:block;overflow:hidden;border-radius:16px;border:1px solid var(--ring);background:linear-gradient(180deg,#11151e,#0e121b)}
    .post-thumb{aspect-ratio:16/9;background-size:cover;background-position:center;background-image:linear-gradient(135deg,#1e2634,#131a27)}
    .post-meta{padding:12px 12px 14px}.post-title{font-weight:900;color:var(--text);font-size:15px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .post-date{font-size:12px;color:#9aa0a6}
    #postView{margin-top:16px}.article h1{font-size:28px;margin:0 0 10px;font-weight:900}
    .article .meta{color:#9aa0a6;font-size:13px;margin-bottom:16px}.article .content{color:#cfd6e4;line-height:1.75}
    .article .content h2{font-size:20px;margin:20px 0 6px}.article .content h3{font-size:17px;margin:16px 0 6px}
    .article .content p{margin:10px 0}.article .content ul{margin:8px 0 12px 20px}.article .content li{margin:4px 0}
    .article .content img{max-width:100%;height:auto;display:block;margin:12px auto;border-radius:12px}
    .footer{margin-top:28px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;color:#9aa0a6}
    .pill{padding:6px 10px;background:var(--panel-2);border:1px solid var(--ring);border-radius:999px;font-size:12px}.link{color:#8ab4f8;text-underline-offset:2px}
  </style>
</head>
<body>
<div class="container">
  <header class="site">
    <div class="brand"><div class="logo"><span>🍅</span></div><div class="wordmark">POMODORO+</div></div>
    <nav><a href="#">홈</a><a href="#blog">블로그</a><a href="#about">소개</a><a href="#contact">연락처</a></nav>
  </header>
  <main>
    <section id="homeFlag" class="row">
      <section class="card timer-card" aria-label="타이머">
        <div id="modeBtns" class="tabs" role="tablist" aria-label="모드">
          <button class="tab" data-mode="focus" aria-selected="true">집중</button>
          <button class="tab" data-mode="short">짧은 휴식</button>
          <button class="tab" data-mode="long">긴 휴식</button>
        </div>
        <div class="ring" aria-live="polite">
          <svg width="100%" height="100%" viewBox="0 0 300 300" aria-hidden="true">
            <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ff8a80"/><stop offset="100%" stop-color="#ff4d4f"/>
            </linearGradient></defs>
            <circle cx="150" cy="150" r="140" fill="none" stroke="var(--ring)" stroke-width="16" />
            <circle id="ring" cx="150" cy="150" r="140" fill="none" stroke="url(#grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0" stroke-dashoffset="0"/>
          </svg>
          <div class="time"><div class="mmss" id="time">25:00</div><div class="mode" id="mode">집중</div></div>
        </div>
        <div class="controls">
          <button id="startBtn" class="primary">시작</button>
          <button id="pauseBtn" class="ghost" hidden>일시정지</button>
          <button id="resetBtn" class="ghost">리셋</button>
          <button id="nextBtn" class="ghost">다음 ▶︎</button>
        </div>
        <div class="muted small" style="margin-top:8px">오늘 완료한 집중: <span id="completed">0</span>회</div>
      </section>
      <section class="card tasks" aria-label="작업">
        <h3>작업</h3>
        <div class="grid-2" style="margin-bottom:8px">
          <div><label for="taskTitle">작업명</label><input id="taskTitle" type="text" placeholder="예: 수학 n제 4단원 복습" /></div>
          <div><label for="taskEst">예상 뽀모 수</label><input id="taskEst" type="number" min="1" value="1" /></div>
        </div>
        <button id="addTaskBtn">작업 추가</button>
        <div id="taskList" style="margin-top:12px; display:grid; gap:8px"></div>
      </section>
    </section>

    <section class="row" style="margin-top:16px">
      <section class="card" style="flex:1 1 380px" aria-label="설정">
        <h3>설정</h3>
        <div class="grid-2">
          <div><label for="focusMin">집중 (분)</label><input id="focusMin" type="number" min="1" /></div>
          <div><label for="shortMin">짧은 휴식 (분)</label><input id="shortMin" type="number" min="1" /></div>
          <div><label for="longMin">긴 휴식 (분)</label><input id="longMin" type="number" min="1" /></div>
          <div><label for="longEvery">긴 휴식 주기 (집중 몇 회마다)</label><input id="longEvery" type="number" min="2" /></div>
          <div><label><input id="autoBreak" type="checkbox" /> 휴식 자동 시작</label></div>
          <div><label><input id="autoFocus" type="checkbox" /> 집중 자동 시작</label></div>
          <div><label><input id="sound" type="checkbox" /> 알림음</label></div>
          <div><label for="volume">볼륨</label><input id="volume" type="range" min="0" max="1" step="0.01" /></div>
          <div><label><input id="notify" type="checkbox" /> 데스크톱 알림</label></div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px">
          <button id="resetToday" type="button" class="ghost">오늘 기록 초기화</button>
          <button id="resetAll" type="button" class="ghost" style="border-color:#b3262e;color:#ffb3b3">전체 데이터 초기화</button>
        </div>
      </section>

      <section class="card" style="flex:1 1 380px" aria-label="통계/가이드">
        <h3>오늘의 기록</h3>
        <div class="pill" style="display:inline-flex; gap:8px; align-items:center">⏱️ <span id="statsToday">0회 · 0분</span> · 🔥 <span id="streak">0일 연속</span></div>
        <details style="margin-top:14px">
          <summary>뽀모도로 팁 (간단 요약)</summary>
          <ul>
            <li>25분 집중 + 5분 휴식(4회 후 15분 휴식)을 기본으로 시작하고, 본인에게 맞게 조정하세요.</li>
            <li>각 세션에는 <b>하나의 구체적인 작업</b>만 선택하세요. 시작 전에 목표를 한 줄로 기록해 보세요.</li>
            <li>휴식 시간에는 뇌를 쉬게 하세요. 휴대전화는 멀리 두고, 물을 마시거나 가볍게 스트레칭해 보세요.</li>
            <li>하루가 끝나면 오늘의 세션/시간을 확인하고, 내일의 작업을 미리 등록해 두세요.</li>
          </ul>
          <p class="notice">※ 기록은 이 브라우저에만 저장됩니다(localStorage). 다른 기기와는 동기화되지 않습니다.</p>
        </details>
      </section>
    </section>

    <section class="card" aria-label="최근 게시글" id="blog" style="margin-top:16px">
      <h3>최근 글</h3>
      <div class="blog-grid" id="blogGrid" aria-live="polite"></div>
      <div style="margin-top:10px"><a href="#" class="link">모든 글 보기 →</a></div>
    </section>

    <section id="postView" class="card article" hidden>
      <div class="meta"><a href="#" id="backHome" class="link">← 목록으로</a></div>
      <article class="content" id="article"></article>
    </section>
  </main>

  <div class="footer">
    <div class="small">© POMODORO+ · 학습 생산성 블로그 & 타이머</div>
    <div class="small">이 프리뷰는 단일 파일이야. 실제 사이트 패키지는 별도 제공.</div>
  </div>
</div>

<script>
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const store = { get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(_){ return d } }, set(k, v){ localStorage.setItem(k, JSON.stringify(v)) } };
  const fmt2 = n=>String(n).padStart(2,'0');
  const todayKey = ()=> new Date().toISOString().slice(0,10);

  // Audio & Notification
  let audioCtx=null; let audioUnlocked=false;
  function ensureAudio(){ try{ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended'){ audioCtx.resume(); } audioUnlocked=true; }catch(e){ console.warn('Audio init failed', e); } }
  function playChime(kind='done'){
    if(!state.sound || !audioCtx || !audioUnlocked) return;
    const vol = Math.max(0, Math.min(1, state.volume||0.4));
    function tone(freq, dur, start){
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=freq; osc.connect(g); g.connect(audioCtx.destination);
      const t0 = audioCtx.currentTime + (start||0);
      g.gain.setValueAtTime(0, t0); g.gain.linearRampToValueAtTime(vol*0.35, t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
      osc.start(t0); osc.stop(t0+dur+0.05);
    }
    if(kind==='focusEnd'){ tone(880,0.12,0.00); tone(1175,0.12,0.15); }
    else { tone(523.25,0.10,0.00); tone(659.25,0.10,0.12); tone(783.99,0.12,0.24); }
  }
  function notifyUser(title, body){ if(!state.notify) return; try{ if('Notification' in window && Notification.permission==='granted'){ new Notification(title,{ body }); } }catch(e){} }

  // Timer state
  const defaultState = { mode:'focus', durations:{focus:25, short:5, long:15}, longInterval:4, completedFocus:0, remainingMs:25*60*1000, isRunning:false, autoStartBreaks:true, autoStartFocus:false, sound:true, volume:0.4, notify:true, selectedTaskId:null };
  let state = Object.assign({}, defaultState, store.get('pomo:state', {}));
  let tasks = store.get('pomo:tasks', []);
  let stats = store.get('pomo:stats', {});
  let endAt=null, rafId=null;

  function durationMs(mode){ return (state.durations[mode]||25)*60*1000 }
  function persist(){ store.set('pomo:state', state) }
  function addStat(key, delta){
    const k=todayKey(); const base=stats[k]||{sessions:0, focusMs:0};
    if(key==='sessions') base.sessions=(base.sessions|0)+delta; else base[key]=(base[key]||0)+delta;
    stats[k]=base; store.set('pomo:stats', stats); renderStats();
  }
  const getTodaySessions = ()=> (stats[todayKey()]?.sessions|0);
  function resetTodayStats(){ const k=todayKey(); stats[k]={sessions:0, focusMs:0}; store.set('pomo:stats', stats); }
  function resetAllData(){ localStorage.removeItem('pomo:state'); localStorage.removeItem('pomo:tasks'); localStorage.removeItem('pomo:stats'); state=Object.assign({}, defaultState); tasks=[]; stats={}; persist(); }

  function setMode(mode){ state.mode=mode; state.remainingMs=durationMs(mode); state.isRunning=false; endAt=null; clearInterval(rafId); persist(); updateUI(); }
  function start(){ if(state.isRunning) return; state.isRunning=true; endAt=Date.now()+state.remainingMs; tick(); rafId=setInterval(tick,200); persist(); }
  function pause(){ if(!state.isRunning) return; state.isRunning=false; state.remainingMs=Math.max(0,endAt-Date.now()); clearInterval(rafId); rafId=null; persist(); updateUI(); }
  function reset(){ state.isRunning=false; state.remainingMs=durationMs(state.mode); clearInterval(rafId); rafId=null; endAt=null; persist(); updateUI(); }
  function completeSession(){
    if(state.mode==='focus'){
      playChime('focusEnd'); notifyUser('집중 종료','휴식 시간을 시작합니다.');
      state.completedFocus++; addStat('sessions',1); addStat('focusMs', durationMs('focus'));
      if(state.selectedTaskId){ const t=tasks.find(t=>t.id===state.selectedTaskId); if(t){ t.done=Math.min((t.done||0)+1, t.est||99); saveTasks(); renderTasks(); } }
      const nextIsLong=(state.completedFocus%state.longInterval)===0; setMode(nextIsLong?'long':'short'); if(state.autoStartBreaks) start();
    } else { playChime('breakEnd'); notifyUser('휴식 종료','다음 집중을 시작합니다.'); setMode('focus'); if(state.autoStartFocus) start(); }
    persist();
  }
  function next(){ completeSession(); }
  function tick(){ const left=endAt-Date.now(); if(left<=0){ state.remainingMs=0; updateUI(); clearInterval(rafId); rafId=null; completeSession(); return; } state.remainingMs=left; updateUI(); }

  function saveTasks(){ store.set('pomo:tasks', tasks) }
  function addTask(title, est){ const t={id:crypto.randomUUID(), title:title.trim(), est:Math.max(1, est|0), done:0}; if(!t.title) return; tasks.unshift(t); saveTasks(); renderTasks(); if(!state.selectedTaskId){ state.selectedTaskId=t.id; persist(); } }
  function delTask(id){ tasks=tasks.filter(t=>t.id!==id); saveTasks(); if(state.selectedTaskId===id){ state.selectedTaskId=tasks[0]?.id||null; persist(); } renderTasks(); }
  function selTask(id){ state.selectedTaskId=id; persist(); renderTasks(); }

  function mmss(ms){ const t=Math.ceil(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${fmt2(m)}:${fmt2(s)}` }

  function updateUI(){
    const total=durationMs(state.mode); const left=state.remainingMs; const pct=1-Math.max(0,Math.min(1,left/total));
    const r=140, C=2*Math.PI*r, off=C*pct; const ring=$('#ring'); if(ring){ ring.setAttribute('stroke-dasharray', C); ring.setAttribute('stroke-dashoffset', off); }
    const timeEl=$('#time'); if(timeEl) timeEl.textContent=mmss(left);
    const modeEl=$('#mode'); if(modeEl) modeEl.textContent= state.mode==='focus'?'집중':(state.mode==='short'?'짧은 휴식':'긴 휴식');
    document.title = `${mmss(left)} · ${(modeEl?modeEl.textContent:'모드')} — POMODORO+`;
    $$('#modeBtns button').forEach(b=> b.setAttribute('aria-pressed', b.dataset.mode===state.mode));
    const sb=$('#startBtn'), pb=$('#pauseBtn'); if(sb&&pb){ sb.hidden=state.isRunning; pb.hidden=!state.isRunning; }
    const fm=$('#focusMin'), sm=$('#shortMin'), lm=$('#longMin'), le=$('#longEvery'); if(fm) fm.value=state.durations.focus; if(sm) sm.value=state.durations.short; if(lm) lm.value=state.durations.long; if(le) le.value=state.longInterval;
    const ab=$('#autoBreak'), af=$('#autoFocus'), snd=$('#sound'), vol=$('#volume'), nt=$('#notify'); if(ab) ab.checked=state.autoStartBreaks; if(af) af.checked=state.autoStartFocus; if(snd) snd.checked=state.sound; if(vol) vol.value=state.volume; if(nt) nt.checked=state.notify;
    const comp=$('#completed'); if(comp) comp.textContent=getTodaySessions();
  }

  function renderTasks(){
    const wrap=$('#taskList'); if(!wrap) return; wrap.innerHTML='';
    if(tasks.length===0){ wrap.innerHTML='<div class="notice">아직 등록된 작업이 없습니다. 위에서 작업을 추가해 주세요.</div>'; return }
    tasks.forEach(t=>{
      const item=document.createElement('div'); item.className='task-item'; item.setAttribute('aria-current', state.selectedTaskId===t.id);
      item.innerHTML=`
    <input type="radio" name="sel" ${state.selectedTaskId===t.id?'checked':''} aria-label="현재 작업 선택"/>
    <div class="task-title">${escapeHtml(t.title)} <span class="muted small">(${t.done||0}/${t.est})</span></div>
    <div class="task-actions">
      <button class="ok" title="완료 1 증가">+1</button>
      <button class="ghost" title="수정">편집</button>
      <button class="danger" title="삭제">삭제</button>
    </div>`;
      const [radio,,actions]=item.children;
      radio.addEventListener('change',()=>selTask(t.id));
      actions.children[0].addEventListener('click',()=>{ t.done=(t.done||0)+1; saveTasks(); renderTasks(); });
      actions.children[1].addEventListener('click',()=>{ const title=prompt('작업명', t.title); if(title===null) return; const est=parseInt(prompt('예상 뽀모 수', t.est),10); if(!title.trim()) return; t.title=title.trim(); t.est=isNaN(est)?t.est:Math.max(1,est); saveTasks(); renderTasks(); });
      actions.children[2].addEventListener('click',()=>{ if(confirm('삭제할까?')) delTask(t.id) });
      item.addEventListener('click', e=>{ if(e.target.tagName!=='BUTTON' && e.target.tagName!=='INPUT') selTask(t.id) });
      wrap.appendChild(item);
    });
  }

  function renderStats(){
    const k=todayKey(); const s=stats[k]||{sessions:0, focusMs:0};
    const st=$('#statsToday'); if(st) st.textContent=`${s.sessions|0}회 · ${((s.focusMs||0)/60000)|0}분`;
    let streak=0; const dates=Object.keys(stats).sort().reverse(); let cur=new Date();
    for(const d of dates){ const y=cur.toISOString().slice(0,10); if(d===y && (stats[d]?.sessions||0)>0){ streak++; cur.setDate(cur.getDate()-1); } else break; }
    const se=$('#streak'); if(se) se.textContent=`${streak}일 연속`;
  }

  // Blog loader + Router (with images/links + new tab cards)
  let POSTS=[];
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])) }
  function md2html(md){
    let h = md.replace(/^###\s+(.+)$/gm,'<h3>$1</h3>')
              .replace(/^##\s+(.+)$/gm,'<h2>$1</h2>')
              .replace(/^#\s+(.+)$/gm,'<h1>$1</h1>');
    h = h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>');
    h = h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" loading="lazy">');
    h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
    h = h.replace(/(?:^|\n)-\s+(.+)(?=\n|$)/g,'\n<li>$1</li>');
    h = h.replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>');
    h = h.split(/\n{2,}/).map(x=>/^<h\d|<ul>|<li>|<img|<a/.test(x)?x:`<p>${x.trim()}</p>`).join('\n');
    return h;
  }
  async function loadPosts(){
    const grid=$('#blogGrid'); if(!grid) return;
    try{ const res=await fetch('/posts.json',{cache:'no-store'}); if(res.ok) POSTS=await res.json(); }catch(_){ POSTS=[] }
    if(!Array.isArray(POSTS) || POSTS.length===0){
      POSTS=[{slug:'hello',title:'샘플 글',date:'2025-08-01',md:'# 샘플\n\n![샘플 이미지](assets/desk-setup.jpg)'}];
    }
    grid.innerHTML='';
    POSTS.slice(0,12).forEach(p=>{
      const card=document.createElement('a');
      card.href=`#p/${p.slug}`;
      card.target='_blank'; card.rel='noopener'; // 새 탭
      card.className='post-card'; card.dataset.slug=p.slug;
      const styleThumb = p.thumb ? ` style="background-image:url('${p.thumb}');"` : '';
      card.innerHTML=`<div class="post-thumb"${styleThumb}></div>
        <div class="post-meta">
          <div class="post-title">${escapeHtml(p.title||'제목 없음')}</div>
          <div class="post-date">${p.date?escapeHtml(p.date):''}</div>
        </div>`;
      grid.appendChild(card);
    });
  }
  function showHome(){ $('#homeFlag').hidden=false; $('#blog').hidden=false; $('#postView').hidden=true; }
  function showPost(slug){
    const p = POSTS.find(x=>x.slug===slug); if(!p){ showHome(); return; }
    const wrap=$('#article');
    const title=`<h1>${escapeHtml(p.title)}</h1><div class="meta">${escapeHtml(p.date||'')}</div>`;
    let body=''; if(p.html) body=p.html; else if(p.md) body=md2html(p.md); else body='<p>본문이 준비되지 않았어.</p>';
    wrap.innerHTML= title + `<div class="content">${body}</div>`;
    $('#homeFlag').hidden=true; $('#blog').hidden=true; $('#postView').hidden=false;
    document.title = `${p.title} — POMODORO+`;
  }
  function router(){ const m=location.hash.match(/^#p\/(?<slug>[a-z0-9\-]+)$/i); if(m&&m.groups?.slug){ showPost(m.groups.slug) } else { showHome() } }

  function bind(){
    $$('#modeBtns button').forEach(b=> b.addEventListener('click', ()=> setMode(b.dataset.mode)));
    const on=(sel,evt,fn)=>{ const el=$(sel); if(el) el.addEventListener(evt,fn) };
    on('#startBtn','click', ()=>{ ensureAudio(); start(); }); on('#pauseBtn','click', ()=>{ ensureAudio(); pause(); }); on('#resetBtn','click', ()=>{ ensureAudio(); reset(); }); on('#nextBtn','click', next);
    on('#addTaskBtn','click', ()=>{ const title=$('#taskTitle')?.value||''; const est=parseInt($('#taskEst')?.value||'1',10)||1; addTask(title, est); if($('#taskTitle')) $('#taskTitle').value=''; if($('#taskEst')) $('#taskEst').value=1; $('#taskTitle')?.focus(); });
    on('#focusMin','change', e=>{ state.durations.focus=Math.max(1, e.target.value|0); if(state.mode==='focus') state.remainingMs=durationMs('focus'); persist(); updateUI(); });
    on('#shortMin','change', e=>{ state.durations.short=Math.max(1, e.target.value|0); if(state.mode==='short') state.remainingMs=durationMs('short'); persist(); updateUI(); });
    on('#longMin','change', e=>{ state.durations.long=Math.max(1, e.target.value|0); if(state.mode==='long') state.remainingMs=durationMs('long'); persist(); updateUI(); });
    on('#longEvery','change', e=>{ state.longInterval=Math.max(2, e.target.value|0); persist(); });
    on('#autoBreak','change', e=>{ state.autoStartBreaks=e.target.checked; persist(); });
    on('#autoFocus','change', e=>{ state.autoStartFocus=e.target.checked; persist(); });
    on('#sound','change', e=>{ state.sound=e.target.checked; persist(); });
    on('#notify','change', e=>{ state.notify=e.target.checked; if(e.target.checked && Notification && Notification.permission!=='granted') Notification.requestPermission(); persist(); });
    on('#volume','input', e=>{ state.volume=Number(e.target.value); persist(); });
    on('#backHome','click', (e)=>{ e.preventDefault(); location.hash=''; });
    on('#resetToday','click', ()=>{ if(confirm('오늘 기록을 초기화할까요?')){ resetTodayStats(); renderStats(); updateUI(); }});
    on('#resetAll','click', ()=>{ if(confirm('모든 데이터(작업/설정/기록)를 초기화할까요? 이 브라우저에서만 삭제됩니다.')){ resetAllData(); renderTasks(); renderStats(); updateUI(); }});
    window.addEventListener('hashchange', router);
    window.addEventListener('pointerdown', ()=>ensureAudio(), { once:true });
  }
  async function init(){ bind(); if(state.remainingMs>durationMs(state.mode)) state.remainingMs=durationMs(state.mode); updateUI(); renderTasks(); renderStats(); await loadPosts(); router(); }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
